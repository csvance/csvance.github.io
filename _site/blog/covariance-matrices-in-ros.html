<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Covariance Matrices in ROS | Carroll Vance &mdash; CS Undergrad @ UH </title>
    <meta property="og:title" content="Covariance Matrices in ROS | Carroll Vance &mdash; CS Undergrad @ UH " />
    <meta name="twitter:title" content="Covariance Matrices in ROS | Carroll Vance &mdash; CS Undergrad @ UH " />

    <meta name="description" content="I'm an undergrad student interested in embedded systems and machine learning.">
    <meta name="description" property="og:description" content="I'm an undergrad student interested in embedded systems and machine learning." />
    <meta name="twitter:description" content="I'm an undergrad student interested in embedded systems and machine learning." />

    <meta name="twitter:card" content="summary_large_image" />
    
    <meta property="og:url" content="https://csvance.github.io/blog/covariance-matrices-in-ros.html" />

    <meta property="og:image" content="" />
    <meta name="twitter:image" content="" />

    <meta name="author" content="Carroll Vance" />

    <meta name="copyright" content="Copyright by Carroll Vance. All Rights Reserved." />

    <style>
        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 300;
            src: local('Roboto Light'), local('Roboto-Light'), url(https://fonts.gstatic.com/s/roboto/v15/Hgo13k-tfSpn0qi1SFdUfVtXRa8TVwTICgirnJhmVJw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 400;
            src: local('Roboto'), local('Roboto-Regular'), url(https://fonts.gstatic.com/s/roboto/v15/CWB0XYA8bzo0kSThX0UTuA.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 700;
            src: local('Roboto Bold'), local('Roboto-Bold'), url(https://fonts.gstatic.com/s/roboto/v15/d-6IYplOFocCacKzxwXSOFtXRa8TVwTICgirnJhmVJw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 900;
            src: local('Roboto Black'), local('Roboto-Black'), url(https://fonts.gstatic.com/s/roboto/v15/mnpfi9pxYH-Go5UiibESIltXRa8TVwTICgirnJhmVJw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 300;
            src: local('Roboto Light Italic'), local('Roboto-LightItalic'), url(https://fonts.gstatic.com/s/roboto/v15/7m8l7TlFO-S3VkhHuR0at44P5ICox8Kq3LLUNMylGO4.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 400;
            src: local('Roboto Italic'), local('Roboto-Italic'), url(https://fonts.gstatic.com/s/roboto/v15/vPcynSL0qHq_6dX7lKVByfesZW2xOQ-xsNqO47m55DA.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 700;
            src: local('Roboto Bold Italic'), local('Roboto-BoldItalic'), url(https://fonts.gstatic.com/s/roboto/v15/t6Nd4cfPRhZP44Q5QAjcC44P5ICox8Kq3LLUNMylGO4.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 900;
            src: local('Roboto Black Italic'), local('Roboto-BlackItalic'), url(https://fonts.gstatic.com/s/roboto/v15/bmC0pGMXrhphrZJmniIZpY4P5ICox8Kq3LLUNMylGO4.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }
    </style>
    
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon" />
    
    <link rel="stylesheet" href="https://csvance.github.io/assets/css/main.css">

    <link rel="canonical" href="https://csvance.github.io/blog/covariance-matrices-in-ros.html">

    <link rel="alternate" type="application/rss+xml" title="" href="https://csvance.github.io/feed.xml">
</head>

    <body>
        <div class="wrapper clear">
            <aside class="user-profile fixed" role="complementary">
    <div class="burger">
        <input class="trigger hidden" id="toggleBurger" type="checkbox" />
        <label for="toggleBurger">
            <span>Navigation</span>
        </label>
    </div>

    <div class="compact-header">
        <a href="https://csvance.github.io"><img class="avatar" src="https://csvance.github.io/assets/img/avatar.jpeg" /></a>
        <div class="my-info">
            <strong class="my-name">Carroll Vance</strong>
            <span class="my-job-title">CS Undergrad @ UH</span>
        </div>
    </div>

    
        
        <div class="mainmenu">
            <a href="https://csvance.github.io" >Home</a>
            
                
            
                
            
                
            
                
                    <a href="https://csvance.github.io/resume/" >Resume</a>
                
            
                
                    <a href="https://csvance.github.io/portfolio/" >Portfolio</a>
                
            
                
            
                
            
                
            
        </div>
        
    

    <p class="about-me">I'm an undergrad student interested in embedded systems and machine learning.</p>

    <ul class="socials">
        <li><a href="https://github.com/csvance"><svg title="github" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://csvance.github.io/assets/svg/social-icons.svg#github-icon"></use></svg></a></li>

        
            <li><a href="mailto:csvance@uh.edu"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://csvance.github.io/assets/svg/social-icons.svg#email-icon"></use></svg></a></li>
        

        
         <li><a href="https://csvance.github.io/feed.xml"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://csvance.github.io/assets/svg/social-icons.svg#rss-icon"></use></svg></a></li>
        
    </ul>
</aside>


            <main class="the-content" role="main">
                <div class="search" role="search">
    <div>
        <div class="show-results-count">0 Results</div>
        <div class="search-holder clear">
            <input type="text" id="search-input" placeholder="search for...">
        </div>
    </div>
    <ul id="results-container" class="results-container"></ul>
</div>


                <article class="post single" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul class="clear">
            <li><time datetime="2019-01-21T06:00:00-06:00" itemprop="datePublished">21 Jan, 2019</time></li>
            
        </ul>
        <h2 itemprop="name headline">Covariance Matrices in ROS</h2>
    </header>

    <div class="post-content">
        <p>A common issue learning <a href="http://www.ros.org">ROS</a> for those without a background in mathematics (specifically Statistics and Linear Algebra) is how to generate a covariance matrix for various message types, and why one needs to generate such a thing in the first place. Today I will attempt to explain both!</p>

<p><img src="/assets/img/covariance_matrix.png" alt="Covariance Matrix" /></p>
<p align="center">
<b>Covariance Matrix</b><br />
</p>

<h2 id="what-are-covariance-matrices-used-for-anyway">What are covariance matrices used for anyway?</h2>

<p>In robotics, a common problem is how to estimate the robot’s pose in three dimensional space. We need to know where the robot (starting with base_link) is in order to understand where the sensor readings take place. In ROS most things are relative to base_link so we if we don’t know where base_link is we don’t know where laser_scanner, camera, or any of our other sensors are! If we don’t know where the sensor is, we don’t know where the readings apply to in space. Covariance matrices help us with robotic state estimation problems in two different ways here:</p>

<ul>
  <li>The diagonal of a covariance matrix is simply the variance of one of our sensor readings. By knowing the variance, we know how its potential error increases over time. So we have an estimate of how wrong our various sensor readings are, which is important to know for using them to estimate other things.</li>
  <li>State estimation algorithms can use the non diagonal entries (covariance) of the covariance matrix to reduce error in readings by understanding how things vary with other things. A positive covariance tells us that when one reading is high, the other one is likely to be as well. A negative covariance tells us the opposite.</li>
</ul>

<h2 id="something-practical">Something Practical</h2>

<p>A practical example of a covariance matrix is using an IMU sensor to improve our estimation of our current position and heading. An IMU can help with this by letting the robot know how much it is accelerating and how fast it is rotating. Knowing this information lets the robot have an easier time estimating its future position based on its current.</p>

<p>Lets look at the simplest case possible, a robot that only lives in the X and Y dimension. At T=0s, the robot is at (x=0, y=0), and our acceleromter is telling us we are accelerating at (x=1, y=0) m/s^2. At T=1s we see our acceleration remains constant, and want to know how far the robot moved and how fast it is going. Newton taught us that velocity is the derivative of position, and acceleration the derivative of velocity. So we need to apply the inverse operation of the derivative, the integral. However, because we are only working with numerical sensor readings, we need to use a numerical integration method. Ideally we would use Simpson’s rule or the trapezoid rule, but because our acceleration is constant it forms a rectangle shape, so we can just multiply our delta T (1s - 0s) by our acceleration (1 m/s^2). Our speed is increases from 0 to 1 m/s over 1 second. We can either integrate or calculate the area of the triangle 1/2 base*height. This gives us a position of (x=0.5, y=0) m. Now consider how the covariance matrix plays into this estimation.</p>

<p>Let’s start by looking at the variance of acceleration. In this particular case we found it to be (x=0.001, y=0.002). This means it has a standard deviation of (x=0.0316, y=0.0447) by taking the square root of the variance. Because the covariance matrix is calculated using individual samples, we need to multiply the standard deviation of X by the number of samples during the delta T to understand how wrong we potentially are. Say we sample the IMU at 10Hz, so +/- 10 * 0.0316 = +/- 0.316 and +/- 10 * 0.0447 = +/- 0.447, so we know that our velocity is between (x=0.684, y=0.553) and (x=1.316, y=1.447). Consequentially, our position is in between (x=0.342, y=0.2765) and (x=0.658, y=0.7235). Knowing the confidence of these reading effects how much weight a state estimation algorithm will put on that particular parameters accuracy in its estimation of other things.</p>

<p>The concept for covariance is similar, but the details are far more complicated. Just know that state estimation systems such as <a href="https://en.wikipedia.org/wiki/Extended_Kalman_filter">Extended Kalman Filters</a> use this information in order to increase the confidence of the readings to make better predictions about the state.</p>

<h2 id="how-to-calculate-a-sampling-covariance-matrix">How to calculate a (sampling) covariance matrix?</h2>

<p>Lets consider the case again of an IMU sensor. We want to measure the sampling noise of the linear acceleration when it is completely still. We create a matrix A containing 3 rows (x, y, z) and 100 columns (individual readings). Next, we calculate the row mean of x, y, and z. We subtract each rows row mean from itself. This gives us a matrix B. Next, we matrix multiply B*B^T. Finally we divide the resulting matrix by n, the number of samples we recorded.</p>

<p><img src="/assets/img/covariance_calculation.png" alt="Covariance Calculation" /></p>

<p>When we multiply two matrices together, the result has the dimensions of their outside dimensions. So 3 x 100 * 100 x 3 = 3 x 3. So we now have a 3 x 3 covariance matrix, and we need to add it to our ROS IMU messages. The <a href="http://docs.ros.org/api/sensor_msgs/html/msg/Imu.html">IMU message</a> in ROS contains an array called linear_acceleration_covariance which has 9 floating point values. We can simply reshape our matrix to a 9 element array, and store the values in linear_acceleration_covariance. In our covariance array, indexes 0, 3, and 6 (the diagonals) will contain variances, and the rest of the indexes contain covariances between variables.</p>

<p>Keep in mind that this process is only taking into account sampling noise from the sensor, rather than inherent inaccuracies that may be present.</p>

<p>For an example of calculating a covariance matrix with a real sensor and data within a ROS node, see my <a href="https://github.com/csvance/lsm9ds0/blob/master/src/lsm9ds0_node.py">LSM9DS0 IMU ROS node</a>.</p>


    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=Covariance Matrices in ROS&p[summary]=A common issue learning ROS for those without a background in mathematics (specifically Statistics and Linear Algebra) is how to generate...&p[url]=https://csvance.github.io/blog/covariance-matrices-in-ros.html" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://csvance.github.io/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=https://csvance.github.io/blog/covariance-matrices-in-ros.html&text=A common issue learning ROS for those without a background in mathematics (specifically Statistics and Linear Algebra) is how to generate...&hashtags=" rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://csvance.github.io/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
            </ul>
        </div>
        
    </footer>
</article>


<aside class="comments" role="complementary">
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = 'https://csvance.github.io/blog/covariance-matrices-in-ros.html';
            this.page.identifier = '1/21/2019';
        };
        (function() {
            var d = document, s = d.createElement('script');

            s.src = '//.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
</aside>

            </main>
        </div>

        <script src="https://csvance.github.io/assets/js/jquery-1.12.2.min.js"></script>
<script src="https://csvance.github.io/assets/js/backtotop.js"></script>
<script src="https://csvance.github.io/assets/js/lunr.min.js"></script>
<script src="https://csvance.github.io/assets/js/lunr-feed.js"></script>
<script src="https://csvance.github.io/assets/js/jquery.fitvids.js"></script>
<script src="https://csvance.github.io/assets/js/svg4everybody.min.js"></script>
<script src="https://csvance.github.io/assets/js/scripts.js"></script>


    </body>
</html>